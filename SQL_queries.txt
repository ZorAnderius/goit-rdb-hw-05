Task 1.

use hw2;

SELECT 
	od.*,
    (SELECT o.customer_id
    FROM orders AS o
    WHERE o.id = od.order_id) AS customer_id
FROM order_details AS od;


Task 2.

use hw2;

SELECT 
	od.*
FROM order_details AS od
WHERE od.order_id IN (SELECT o.id 
			   FROM orders AS o 
               WHERE o.shipper_id = 3);


Task 3.

use hw2;

SELECT 
	od.order_id,
    AVG(od.quantity) AS average_quantity
FROM (SELECT order_id, quantity 
      FROM order_details 
      WHERE quantity > 10) AS od
GROUP BY od.order_id;


Task 4.

use hw2;

WITH TempTable AS (
	SELECT order_id, quantity
    FROM order_details
    WHERE quantity > 10
)
SELECT 
	od.order_id,
    AVG(od.quantity) AS average_quantity
FROM TempTable as od
GROUP BY od.order_id;

Task 5.

use hw2;

DROP FUNCTION IF EXISTS ReduceValue;

DELIMITER //

CREATE FUNCTION ReduceValue(numerator FLOAT, denominator FLOAT)
RETURNS FLOAT
DETERMINISTIC
NO SQL
BEGIN
    RETURN IF(denominator > 0, numerator / denominator, numerator);
END //

DELIMITER ;


WITH TempTable AS (
	SELECT order_id, quantity
    FROM order_details
    WHERE quantity > 10
)
SELECT 
	od.order_id,
    od.quantity as origin_quantity,
    ReduceValue(od.quantity, 2) AS reduced_quantity
FROM TempTable as od;